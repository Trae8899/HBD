{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://hbd.example.com/schema/case.schema.json",
  "title": "CCPP HBD Case Schema v0.3",
  "description": "Schema definition for fixed/vary/device based CCPP HBD case files (v0.3)",
  "type": "object",
  "required": [
    "schema_version",
    "units_system",
    "fixed"
  ],
  "additionalProperties": false,
  "properties": {
    "schema_version": {
      "const": "0.3",
      "description": "Case schema version. Only v0.3 is supported by this release."
    },
    "units_system": {
      "type": "string",
      "enum": ["SI_IF97"],
      "description": "Global unit system flag (SI with IAPWS-IF97 steam properties)."
    },
    "fixed": {
      "$ref": "#/definitions/fixedBlock"
    },
    "vary": {
      "$ref": "#/definitions/varyBlock"
    },
    "devices": {
      "$ref": "#/definitions/deviceList"
    },
    "constraints": {
      "$ref": "#/definitions/caseConstraints"
    },
    "meta": {
      "type": "object",
      "description": "Optional metadata describing author, site, or notes.",
      "additionalProperties": true
    }
  },
  "definitions": {
    "temperatureC": {
      "type": "number",
      "minimum": -273.15,
      "maximum": 2000.0
    },
    "efficiency": {
      "type": "number",
      "minimum": 0.0,
      "maximum": 1.0
    },
    "pressureBar": {
      "type": "number",
      "minimum": 0.0,
      "maximum": 250.0
    },
    "fixedBlock": {
      "type": "object",
      "required": [
        "plant",
        "ambient",
        "gas_turbine",
        "hrsg",
        "steam_turbine",
        "condenser",
        "bop"
      ],
      "additionalProperties": false,
      "properties": {
        "plant": {
          "type": "object",
          "required": ["topology"],
          "additionalProperties": false,
          "properties": {
            "topology": {
              "type": "string",
              "enum": [
                "single-shaft-1x1",
                "multi-shaft-2x1",
                "multi-shaft-3x1"
              ]
            },
            "site_name": {
              "type": "string"
            }
          }
        },
        "ambient": {
          "type": "object",
          "required": ["Ta_C", "RH_pct", "P_bar"],
          "additionalProperties": false,
          "properties": {
            "Ta_C": {
              "type": "number",
              "minimum": -40.0,
              "maximum": 60.0,
              "description": "Ambient dry bulb temperature in Â°C"
            },
            "RH_pct": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 100.0,
              "description": "Relative humidity in %"
            },
            "P_bar": {
              "type": "number",
              "minimum": 0.8,
              "maximum": 1.1,
              "description": "Ambient pressure in bar(abs)"
            }
          }
        },
        "gas_turbine": {
          "type": "object",
          "required": [
            "ISO_power_MW",
            "ISO_heat_rate_kJ_per_kWh",
            "fuel_LHV_kJ_per_kg",
            "ISO_exhaust_temp_C",
            "ISO_exhaust_flow_kg_s"
          ],
          "additionalProperties": false,
          "properties": {
            "model": {
              "type": "string",
              "description": "Model identifier or short name"
            },
            "ISO_power_MW": {
              "type": "number",
              "minimum": 50.0,
              "maximum": 600.0
            },
            "ISO_heat_rate_kJ_per_kWh": {
              "type": "number",
              "minimum": 8000.0,
              "maximum": 12000.0
            },
            "fuel_LHV_kJ_per_kg": {
              "type": "number",
              "minimum": 38000.0,
              "maximum": 52000.0
            },
            "ISO_exhaust_temp_C": {
              "type": "number",
              "minimum": 450.0,
              "maximum": 700.0
            },
            "ISO_exhaust_flow_kg_s": {
              "type": "number",
              "minimum": 200.0,
              "maximum": 900.0
            },
            "corr_coeff": {
              "type": "object",
              "required": [
                "dPower_pct_per_K",
                "dFlow_pct_per_K",
                "dExhT_K_per_K"
              ],
              "additionalProperties": false,
              "properties": {
                "reference_temp_C": {
                  "type": "number",
                  "default": 15.0
                },
                "dPower_pct_per_K": {
                  "type": "number",
                  "minimum": -1.0,
                  "maximum": 0.0
                },
                "dFlow_pct_per_K": {
                  "type": "number",
                  "minimum": 0.0,
                  "maximum": 1.0
                },
                "dExhT_K_per_K": {
                  "type": "number",
                  "minimum": 0.0,
                  "maximum": 2.0
                }
              }
            },
            "performance_blend": {
              "$ref": "#/definitions/performanceBlend"
            }
          }
        },
        "hrsg": {
          "type": "object",
          "required": ["hp", "ip", "lp", "stack_temp_min_C"],
          "additionalProperties": false,
          "properties": {
            "feedwater_temp_C": {
              "type": "number",
              "minimum": 60.0,
              "maximum": 150.0
            },
            "hp": {"$ref": "#/definitions/hrsgLevel"},
            "ip": {"$ref": "#/definitions/hrsgLevel"},
            "lp": {"$ref": "#/definitions/hrsgLevel"},
            "stack_temp_min_C": {
              "type": "number",
              "minimum": 70.0,
              "maximum": 150.0
            },
            "constraints": {
              "$ref": "#/definitions/hrsgConstraint"
            },
            "devices": {
              "$ref": "#/definitions/hrsgDevices"
            }
          }
        },
        "steam_turbine": {
          "type": "object",
          "required": [
            "isentropic_eff_hp",
            "isentropic_eff_ip",
            "isentropic_eff_lp",
            "mech_elec_eff"
          ],
          "additionalProperties": false,
          "properties": {
            "isentropic_eff_hp": {"$ref": "#/definitions/efficiency"},
            "isentropic_eff_ip": {"$ref": "#/definitions/efficiency"},
            "isentropic_eff_lp": {"$ref": "#/definitions/efficiency"},
            "mech_elec_eff": {"$ref": "#/definitions/efficiency"}
          }
        },
        "condenser": {
          "type": "object",
          "required": ["vacuum_kPa_abs", "cw_inlet_C"],
          "additionalProperties": false,
          "properties": {
            "vacuum_kPa_abs": {
              "type": "number",
              "minimum": 4.0,
              "maximum": 15.0
            },
            "cw_inlet_C": {
              "type": "number",
              "minimum": 5.0,
              "maximum": 35.0
            }
          }
        },
        "bop": {
          "type": "object",
          "required": ["aux_load_MW"],
          "additionalProperties": false,
          "properties": {
            "aux_load_MW": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 60.0
            }
          }
        }
      }
    },
    "hrsgLevel": {
      "type": "object",
      "required": ["pressure_bar", "steam_temp_C", "pinch_K", "approach_K"],
      "additionalProperties": false,
      "properties": {
        "pressure_bar": {
          "type": "number",
          "minimum": 0.5,
          "maximum": 200.0
        },
        "steam_temp_C": {
          "type": "number",
          "minimum": 150.0,
          "maximum": 620.0
        },
        "pinch_K": {
          "type": "number",
          "minimum": 3.0,
          "maximum": 30.0
        },
        "approach_K": {
          "type": "number",
          "minimum": 2.0,
          "maximum": 20.0
        }
      }
    },
    "hrsgConstraint": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "pinch_mode": {
          "type": "string",
          "enum": ["enforce", "relax"],
          "default": "enforce"
        },
        "approach_mode": {
          "type": "string",
          "enum": ["enforce", "relax"],
          "default": "enforce"
        },
        "stack_mode": {
          "type": "string",
          "enum": ["enforce", "relax"],
          "default": "enforce"
        }
      }
    },
    "hrsgDevices": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "duct_burner": {
          "$ref": "#/definitions/ductBurnerDevice"
        },
        "bypass": {
          "$ref": "#/definitions/bypassDevice"
        },
        "attemperators": {
          "type": "array",
          "items": {"$ref": "#/definitions/attemperatorDevice"},
          "default": []
        }
      }
    },
    "ductBurnerDevice": {
      "type": "object",
      "required": ["duty_MW"],
      "additionalProperties": false,
      "properties": {
        "duty_MW": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 200.0
        },
        "stack_temp_cap_C": {
          "type": "number",
          "minimum": 90.0,
          "maximum": 200.0
        }
      }
    },
    "bypassDevice": {
      "type": "object",
      "required": ["fraction"],
      "additionalProperties": false,
      "properties": {
        "fraction": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 0.5
        }
      }
    },
    "attemperatorDevice": {
      "type": "object",
      "required": ["target", "steam_temp_C"],
      "additionalProperties": false,
      "properties": {
        "target": {
          "type": "string",
          "enum": ["hp", "ip", "lp"]
        },
        "steam_temp_C": {
          "type": "number",
          "minimum": 200.0,
          "maximum": 620.0
        },
        "m_dot_max_kg_s": {
          "type": "number",
          "minimum": 0.1,
          "maximum": 20.0,
          "default": 5.0
        }
      }
    },
    "performanceBlend": {
      "type": "object",
      "required": ["mode"],
      "additionalProperties": false,
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["linear", "vendor_blend"]
        },
        "vendor_curve_id": {
          "type": "string"
        },
        "blend_weight": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "default": 1.0
        }
      }
    },
    "caseConstraints": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "allow_relaxed_pinch": {
          "type": "boolean",
          "default": false
        },
        "allow_relaxed_stack": {
          "type": "boolean",
          "default": false
        }
      }
    },
    "varyBlock": {
      "type": "object",
      "description": "Optional set of sweep axes using dotted key paths.",
      "default": {},
      "propertyNames": {
        "pattern": "^(ambient|gas_turbine|hrsg|steam_turbine|condenser|bop|plant)\\."
      },
      "additionalProperties": {
        "type": "array",
        "minItems": 1,
        "uniqueItems": true,
        "items": {
          "type": "number"
        }
      }
    },
    "deviceList": {
      "type": "array",
      "description": "Optional list of device plug-ins to activate for the case.",
      "items": {"$ref": "#/definitions/device"},
      "default": []
    },
    "device": {
      "type": "object",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": ["attemperator", "duct_firing", "gt_inlet_cool"]
        }
      },
      "allOf": [
        {
          "if": {"properties": {"type": {"const": "attemperator"}}},
          "then": {
            "required": ["target", "control", "limits"],
            "properties": {
              "target": {
                "type": "string",
                "enum": ["hp", "ip", "lp"]
              },
              "control": {
                "type": "object",
                "required": ["steam_temp_C"],
                "additionalProperties": false,
                "properties": {
                  "steam_temp_C": {
                    "type": "number",
                    "minimum": 200.0,
                    "maximum": 620.0
                  }
                }
              },
              "limits": {
                "type": "object",
                "required": ["m_dot_max_kg_s"],
                "additionalProperties": false,
                "properties": {
                  "m_dot_max_kg_s": {
                    "type": "number",
                    "minimum": 0.1,
                    "maximum": 20.0
                  }
                }
              }
            }
          }
        },
        {
          "if": {"properties": {"type": {"const": "duct_firing"}}},
          "then": {
            "required": ["hrsg_section", "Q_add_MW"],
            "properties": {
              "hrsg_section": {
                "type": "string",
                "enum": ["economizer", "evaporator", "superheater"]
              },
              "Q_add_MW": {
                "type": "number",
                "minimum": 1.0,
                "maximum": 200.0
              },
              "stack_temp_cap_C": {
                "type": "number",
                "minimum": 90.0,
                "maximum": 200.0
              }
            }
          }
        },
        {
          "if": {"properties": {"type": {"const": "gt_inlet_cool"}}},
          "then": {
            "required": ["method", "T_db_target_C"],
            "properties": {
              "method": {
                "type": "string",
                "enum": ["evaporative", "chiller", "fogging"]
              },
              "T_db_target_C": {
                "type": "number",
                "minimum": -10.0,
                "maximum": 30.0
              }
            }
          }
        }
      ]
    }
  }
}
